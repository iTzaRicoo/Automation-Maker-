<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automation Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes slideFadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pop {
      0%   { transform: scale(0.98); }
      60%  { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .step-enter { animation: slideFadeIn 260ms ease-out both; }
    .result-pop { animation: pop 260ms ease-out both; }

    .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(0,0,0,0.12);
      border-top-color: rgba(0,0,0,0.55);
      border-radius: 999px;
      animation: spin 700ms linear infinite;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto">

    <!-- Debug Panel -->
    <div id="debugPanel" class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4 mb-4">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold text-yellow-800">üîç Debug Console</h3>
        <button onclick="toggleDebug()" class="text-sm bg-yellow-200 px-3 py-1 rounded">Toggle</button>
      </div>
      <div id="debugLog" class="text-xs font-mono space-y-1 max-h-48 overflow-y-auto"></div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Automation Maker</h1>
          <p class="text-gray-600">Maak, bewerk en test automations (zonder ingewikkelde termen)</p>
        </div>
        <div id="status" class="text-sm">
          <span class="inline-block w-3 h-3 bg-gray-400 rounded-full mr-2 animate-pulse"></span>
          <span>Verbinding maken...</span>
        </div>
      </div>

      <!-- Edit banner -->
      <div id="editBanner" class="hidden mb-5 border-2 border-indigo-300 bg-indigo-50 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-bold text-indigo-800">‚úèÔ∏è Bewerken</div>
            <div id="editBannerText" class="text-sm text-indigo-700"></div>
          </div>
          <button onclick="cancelEdit()"
                  class="bg-white border border-indigo-300 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
            Annuleren
          </button>
        </div>
      </div>

      <!-- Test runner -->
      <div id="testPanel" class="hidden mb-5 border-2 border-slate-200 bg-slate-50 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-bold text-slate-800">üß™ Test</div>
            <div class="text-sm text-slate-600">
              We doen alsof het <b>WANNEER</b> klopt en voeren alleen <b>DAN</b> uit.
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="eli5Btn" onclick="toggleELI5()"
                    class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors">
              üß∏ Leg uit alsof ik 5 ben: UIT
            </button>
            <button onclick="hideTest()"
                    class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors">
              Sluiten
            </button>
          </div>
        </div>
        <div id="testSteps" class="mt-3 space-y-2"></div>
      </div>

      <!-- Form -->
      <div class="mb-6">
        <label class="block text-lg font-semibold text-gray-700 mb-2">Naam</label>
        <input type="text" id="name" placeholder="bijv. Lamp aan in de avond"
               class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none" />
      </div>

      <div class="mb-6 bg-green-50 p-5 rounded-xl">
        <label class="block text-lg font-semibold text-gray-700 mb-3">WANNEER</label>
        <select id="triggerType" onchange="showTrigger()"
                class="w-full px-4 py-3 mb-3 text-lg border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none">
          <option value="">-- Kies wanneer --</option>
          <option value="time">Op een tijdstip</option>
          <option value="state">Als iets verandert</option>
          <option value="sun">Zonsopgang/ondergang</option>
        </select>
        <div id="triggerInputs"></div>

        <!-- Days selector -->
        <div id="daysSelector" class="hidden mt-4 border-2 border-green-200 bg-white rounded-xl p-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Op welke dagen? (optioneel)</label>
          <div class="text-xs text-gray-600 mb-3">Selecteer niets voor alle dagen</div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="mon" class="day-checkbox w-4 h-4">
              <span>Maandag</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="tue" class="day-checkbox w-4 h-4">
              <span>Dinsdag</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="wed" class="day-checkbox w-4 h-4">
              <span>Woensdag</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="thu" class="day-checkbox w-4 h-4">
              <span>Donderdag</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="fri" class="day-checkbox w-4 h-4">
              <span>Vrijdag</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="sat" class="day-checkbox w-4 h-4">
              <span>Zaterdag</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" value="sun" class="day-checkbox w-4 h-4">
              <span>Zondag</span>
            </label>
          </div>
        </div>
      </div>

      <div class="mb-6 bg-blue-50 p-5 rounded-xl">
        <label class="block text-lg font-semibold text-gray-700 mb-3">DAN</label>
        <select id="actionType" onchange="showAction()"
                class="w-full px-4 py-3 mb-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none">
          <option value="">-- Kies wat er moet gebeuren --</option>
          <option value="turn_on">Zet aan</option>
          <option value="turn_off">Zet uit</option>
          <option value="notify">Laat een melding zien</option>
          <option value="scene">Start een scene</option>
        </select>
        <div id="actionInputs"></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button onclick="save()"
                class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-4 px-6 rounded-xl text-lg font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all shadow-lg">
          üíæ Opslaan
        </button>

        <button onclick="testRun()"
                class="w-full bg-gradient-to-r from-slate-700 to-slate-900 text-white py-4 px-6 rounded-xl text-lg font-semibold hover:from-slate-800 hover:to-black transition-all shadow-lg">
          üß™ Test
        </button>
      </div>
    </div>

    <!-- List -->
    <div id="list" class="bg-white rounded-2xl shadow-xl p-6 hidden">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h2 class="text-2xl font-bold text-gray-800">
          Opgeslagen Automations (<span id="count">0</span>)
        </h2>
        <div class="w-full sm:w-80">
          <input id="searchBox" type="text" placeholder="Zoek‚Ä¶ (bijv. lamp avond, woonkamer, verwarming)"
                 class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-indigo-500 focus:outline-none"
                 oninput="onSearchInput()" />
        </div>
      </div>

      <div id="items" class="space-y-3"></div>
    </div>

  </div>

  <script>
    // Ingress-friendly base
    const API_BASE = window.location.pathname.replace(/\/$/, '');
    let entities = [];
    let debugVisible = true;
    let editingFilename = null;

    // ELI5 mode
    let explainLike5 = false;

    // Search debounce
    let searchTimer = null;
    let currentQuery = '';

    function toggleELI5() {
      explainLike5 = !explainLike5;
      const btn = document.getElementById('eli5Btn');
      if (btn) btn.textContent = explainLike5 ? 'üß∏ Leg uit alsof ik 5 ben: AAN' : 'üß∏ Leg uit alsof ik 5 ben: UIT';
      log(`ELI5 mode: ${explainLike5 ? 'ON' : 'OFF'}`, 'info');
    }

    // ----------------------------
    // Debug + Status
    // ----------------------------
    function log(message, type = 'info') {
      const el = document.getElementById('debugLog');
      const ts = new Date().toLocaleTimeString();
      const color =
        type === 'error' ? 'text-red-700' :
        type === 'success' ? 'text-green-700' :
        type === 'warn' ? 'text-yellow-700' :
        'text-gray-800';

      const line = document.createElement('div');
      line.className = color;
      line.textContent = `[${ts}] ${message}`;
      el.prepend(line);
    }

    function toggleDebug() {
      debugVisible = !debugVisible;
      const panel = document.getElementById('debugPanel');
      if (debugVisible) panel.classList.remove('hidden');
      else panel.classList.add('hidden');
    }

    function setStatus(text, color = 'gray') {
      document.getElementById('status').innerHTML =
        `<span class="inline-block w-3 h-3 bg-${color}-500 rounded-full mr-2"></span>` +
        `<span class="text-${color}-700">${text}</span>`;
    }

    async function testAPI(endpoint) {
      const url = API_BASE + endpoint;
      try {
        const response = await fetch(url);
        if (response.ok) {
          const data = await response.json();
          return { ok: true, data };
        }
        return { ok: false, status: response.status };
      } catch (error) {
        log(`Fetch error: ${error.message}`, 'error');
        return { ok: false, error: error.message };
      }
    }

    async function init() {
      setStatus('Verbinden...', 'yellow');
      const health = await testAPI('/api/health');
      if (!health.ok) {
        setStatus('Geen verbinding', 'red');
        return;
      }

      setStatus('Entiteiten laden...', 'yellow');
      const entitiesResult = await testAPI('/api/entities');
      if (!entitiesResult.ok) {
        setStatus('Entiteiten laden mislukt', 'red');
        return;
      }

      entities = entitiesResult.data;
      setStatus(`Verbonden`, 'green');
      loadList(); // initial load
    }

    // ----------------------------
    // Helpers
    // ----------------------------
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function isLightEntity(entityId) {
      return (entityId || '').startsWith('light.');
    }

    function entitySelect(id, domains = [], onChange = '') {
      let filtered = entities;
      if (domains.length > 0) filtered = entities.filter(e => domains.includes(e.domain));

      let html = `<select id="${id}" ${onChange ? `onchange="${onChange}"` : ''}
                 class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none">`;
      html += '<option value="">-- Kies iets --</option>';
      filtered.forEach(e => {
        html += `<option value="${e.entity_id}">${escapeHtml(e.name)}</option>`;
      });
      html += '</select>';
      return html;
    }

    function prettyTargetLabel(entityId) {
      const found = entities.find(e => e.entity_id === entityId);
      if (found && found.name) return found.name;
      if ((entityId || '').startsWith('light.')) return 'een lamp';
      if ((entityId || '').startsWith('switch.')) return 'een schakelaar';
      if ((entityId || '').startsWith('fan.')) return 'een ventilator';
      if ((entityId || '').startsWith('input_boolean.')) return 'een schakelaar (virtueel)';
      if ((entityId || '').startsWith('scene.')) return 'een scene';
      return 'iets';
    }

    function colorHexToRgbArray(hex) {
      const v = (hex || '#ffffff').replace('#','');
      const r = parseInt(v.slice(0,2), 16);
      const g = parseInt(v.slice(2,4), 16);
      const b = parseInt(v.slice(4,6), 16);
      return [r,g,b];
    }

    function formatWarnings(warnings) {
      if (!warnings || !warnings.length) return '';
      return warnings.map(w => {
        const sev = (w.severity || 'info').toUpperCase();
        return `- [${sev}] ${w.warning || ''}`;
      }).join('\n');
    }

    async function postJSON(url, bodyObj) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(bodyObj),
      });
      const data = await resp.json().catch(() => ({}));
      return { resp, data };
    }

    // ----------------------------
    // Trigger UI
    // ----------------------------
    function showTrigger(prefill = null) {
      const type = prefill?.type ?? document.getElementById('triggerType').value;
      const container = document.getElementById('triggerInputs');
      const daysSelector = document.getElementById('daysSelector');

      if (!type) {
        container.innerHTML = '';
        daysSelector.classList.add('hidden');
        return;
      }

      daysSelector.classList.remove('hidden');

      if (prefill?.days) {
        setTimeout(() => {
          document.querySelectorAll('.day-checkbox').forEach(cb => {
            cb.checked = prefill.days.includes(cb.value);
          });
        }, 0);
      } else {
        // if switching trigger type while editing, don't keep old checks unless explicitly provided
        setTimeout(() => {
          if (!prefill) document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
        }, 0);
      }

      if (type === 'time') {
        const v = prefill?.value ?? '12:00';
        container.innerHTML =
          '<label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Tijd:</label>' +
          `<input type="time" id="triggerValue" value="${v}"
             class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"/>`;
      } else if (type === 'state') {
        container.innerHTML =
          '<label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Wat moet veranderen?</label>' +
          entitySelect('triggerValue');
        if (prefill?.value) setTimeout(() => document.getElementById('triggerValue').value = prefill.value, 0);
      } else if (type === 'sun') {
        const event = prefill?.sunEvent ?? 'sunrise';
        const offset = prefill?.sunOffset ?? 'after';
        const mins = prefill?.sunMinutes ?? '0';
        container.innerHTML = `
          <label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Moment:</label>
          <select id="sunEvent"
            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none">
            <option value="sunrise">Zonsopgang</option>
            <option value="sunset">Zonsondergang</option>
          </select>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Timing:</label>
              <select id="sunOffset"
                class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none">
                <option value="after">Na</option>
                <option value="before">Voor</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Aantal minuten:</label>
              <input id="sunMinutes" type="number" min="0" value="${mins}"
                class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none" />
            </div>
          </div>
        `;
        setTimeout(() => {
          document.getElementById('sunEvent').value = event;
          document.getElementById('sunOffset').value = offset;
        }, 0);
      }
    }

    // ----------------------------
    // Action UI
    // ----------------------------
    function renderLightExtras(prefill = null) {
      const b = (prefill?.brightness ?? 255);
      return `
        <div id="lightExtras" class="mt-4 border-2 border-blue-200 bg-white rounded-xl p-4">
          <div class="font-semibold text-gray-800 mb-3">üí° Lamp instellingen</div>

          <label class="block text-sm font-semibold text-gray-700 mb-2">Kies een kleur</label>
          <div class="flex items-center gap-3">
            <input type="color" id="lightColor" value="${prefill?.colorPickerValue || '#ffffff'}"
                   class="w-16 h-12 border-2 border-gray-300 rounded-xl" />
            <div class="text-sm text-gray-600">Klik op het vakje en kies je kleur.</div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2">Helderheid</label>
            <input type="range" id="lightBrightness" min="0" max="255" value="${b}"
                   class="w-full" oninput="document.getElementById('brightnessValue').textContent=this.value" />
            <div class="text-sm text-gray-600 mt-1">Niveau: <span id="brightnessValue">${b}</span></div>
          </div>
        </div>
      `;
    }

    function onActionEntityChanged() {
      const entityId = document.getElementById('actionValue')?.value || '';
      const extrasHost = document.getElementById('actionExtrasHost');
      if (!extrasHost) return;

      const actionType = document.getElementById('actionType').value;

      if (actionType === 'turn_on' && isLightEntity(entityId)) {
        extrasHost.innerHTML = renderLightExtras();
      } else {
        extrasHost.innerHTML = '';
      }
    }

    function showAction(prefill = null) {
      const type = prefill?.type ?? document.getElementById('actionType').value;
      const container = document.getElementById('actionInputs');

      if (!type) { container.innerHTML = ''; return; }

      if (type === 'turn_on' || type === 'turn_off') {
        container.innerHTML =
          '<label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Wat moet er gebeuren met:</label>' +
          entitySelect('actionValue', ['light', 'switch', 'fan', 'input_boolean'], 'onActionEntityChanged()') +
          '<div id="actionExtrasHost"></div>';

        setTimeout(() => {
          if (prefill?.value) document.getElementById('actionValue').value = prefill.value;

          onActionEntityChanged();

          if (type === 'turn_on' && isLightEntity(prefill?.value)) {
            if (prefill?.color_rgb && prefill.color_rgb.length === 3) {
              const [r,g,b] = prefill.color_rgb.map(n => Number(n) || 0);
              const hex = '#' + [r,g,b].map(x => ('0' + x.toString(16)).slice(-2)).join('');
              const c = document.getElementById('lightColor');
              if (c) c.value = hex;
            }
            if (prefill?.brightness !== undefined) {
              const br = document.getElementById('lightBrightness');
              const bv = document.getElementById('brightnessValue');
              if (br) br.value = preillSafeNum(prefill.brightness, 255);
              if (bv) bv.textContent = preillSafeNum(prefill.brightness, 255);
            }
          }
        }, 0);

      } else if (type === 'notify') {
        const msg = prefill?.value ?? '';
        const svc = prefill?.service ?? 'notify.notify';
        container.innerHTML = `
          <label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Waar moet de melding heen?</label>
          <input type="text" id="notifyService" value="${svc}"
                 class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"/>

          <label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Wat moet er in de melding staan?</label>
          <textarea id="actionValue" rows="3"
                    class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none">${msg}</textarea>
        `;
      } else if (type === 'scene') {
        container.innerHTML =
          '<label class="block text-sm font-semibold text-gray-700 mb-2 mt-3">Welke scene?</label>' +
          '<input type="text" id="actionValue" placeholder="scene.naam" class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"/>';
        setTimeout(() => { if (prefill?.value) document.getElementById('actionValue').value = prefill.value; }, 0);
      }
    }

    function preillSafeNum(v, fallback) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    // ----------------------------
    // Edit / Form helpers
    // ----------------------------
    function showEditBanner(filename) {
      const banner = document.getElementById('editBanner');
      const text = document.getElementById('editBannerText');
      banner.classList.remove('hidden');
      text.innerHTML = `Je bewerkt: <span class="font-mono font-semibold">${escapeHtml(filename)}</span>`;
    }

    function hideEditBanner() {
      document.getElementById('editBanner').classList.add('hidden');
      document.getElementById('editBannerText').innerHTML = '';
    }

    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('triggerType').value = '';
      document.getElementById('actionType').value = '';
      document.getElementById('triggerInputs').innerHTML = '';
      document.getElementById('actionInputs').innerHTML = '';
      document.getElementById('daysSelector').classList.add('hidden');
      document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
    }

    function cancelEdit() {
      editingFilename = null;
      hideEditBanner();
      clearForm();
      log('Edit cancelled', 'warn');
    }

    // ----------------------------
    // Test panel
    // ----------------------------
    function hideTest() {
      document.getElementById('testPanel').classList.add('hidden');
      document.getElementById('testSteps').innerHTML = '';
    }

    function actionHeadline(action) {
      if (!action) return explainLike5 ? 'We doen iets' : 'We voeren een actie uit';
      if (action.type === 'turn_on') return explainLike5 ? 'We zetten iets aan üëÜ' : 'We zetten iets AAN';
      if (action.type === 'turn_off') return explainLike5 ? 'We zetten iets uit üëá' : 'We zetten iets UIT';
      if (action.type === 'notify') return explainLike5 ? 'We laten een berichtje zien üí¨' : 'We laten een melding zien';
      if (action.type === 'scene') return explainLike5 ? 'We zetten een sfeer aan ‚ú®' : 'We starten een scene';
      return explainLike5 ? 'We doen iets' : 'We voeren een actie uit';
    }

    function renderActionPreviewCard(automation) {
      const action = automation?.action || {};
      const targetLabel = prettyTargetLabel(action.value);

      let extra = '';
      if (action.type === 'turn_on' && isLightEntity(action.value)) {
        const rgb = action.color_rgb;
        const br = action.brightness ?? 255;

        if (rgb && rgb.length === 3) {
          const opacity = Math.max(0.2, (Number(br) || 255) / 255);
          extra = `
            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="text-sm text-gray-600">
                ${explainLike5 ? 'We kiezen een kleurtje en hoe fel het lampje is.' : 'Kleur en helderheid worden toegepast.'}
              </div>
              <div class="w-12 h-12 rounded-xl border" style="background: rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]}); opacity:${opacity}"></div>
            </div>
          `;
        }
      }

      return `
        <div class="border-2 border-slate-200 bg-white rounded-xl p-4 step-enter">
          <div class="text-lg font-bold text-slate-800">üëÄ Wat gaat er gebeuren?</div>
          <div class="mt-1 text-slate-700">${actionHeadline(action)}</div>
          <div class="text-sm text-slate-500 mt-1">
            ${explainLike5 ? 'Voor:' : 'Doel:'} <span class="font-semibold">${escapeHtml(targetLabel)}</span>
          </div>
          ${extra}
        </div>
      `;
    }

    function stepCard({ icon, title, text, ok, extra }, state = 'done') {
      const border =
        state === 'running' ? 'border-yellow-200 bg-yellow-50' :
        ok ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50';

      const left =
        state === 'running'
          ? `<div class="spinner mt-1"></div>`
          : `<div class="text-2xl leading-none">${icon}</div>`;

      const showDetails = (!explainLike5 && extra && Object.keys(extra).length);

      return `
        <div class="border-2 ${border} rounded-xl p-4 step-enter">
          <div class="flex items-start gap-3">
            <div class="w-8 flex justify-center">${left}</div>
            <div class="flex-1">
              <div class="font-semibold text-slate-800">${escapeHtml(title)}</div>
              <div class="text-sm text-slate-600 mt-1">${escapeHtml(text)}</div>
              ${showDetails ? `
                <details class="mt-2">
                  <summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-700">üîß Technische details</summary>
                  <pre class="text-xs bg-slate-100 p-2 rounded mt-1 overflow-x-auto">${JSON.stringify(extra, null, 2)}</pre>
                </details>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // ----------------------------
    // Save automation (met confirmation flow)
    // ----------------------------
    function readFormData() {
      const name = document.getElementById('name').value.trim();
      const triggerType = document.getElementById('triggerType').value;
      const actionType = document.getElementById('actionType').value;

      if (!name) { alert('Vul eerst een naam in!'); return null; }
      if (!triggerType) { alert('Kies eerst WANNEER!'); return null; }
      if (!actionType) { alert('Kies eerst DAN!'); return null; }

      const trigger = { type: triggerType };

      const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value);
      if (selectedDays.length > 0) trigger.days = selectedDays;

      if (triggerType === 'time') {
        trigger.value = document.getElementById('triggerValue')?.value || '12:00';
      } else if (triggerType === 'state') {
        trigger.value = document.getElementById('triggerValue')?.value || '';
        if (!trigger.value) { alert('Kies eerst wat er moet veranderen bij WANNEER!'); return null; }
      } else if (triggerType === 'sun') {
        trigger.sunEvent = document.getElementById('sunEvent')?.value || 'sunrise';
        trigger.sunOffset = document.getElementById('sunOffset')?.value || 'after';
        trigger.sunMinutes = document.getElementById('sunMinutes')?.value || '0';
      }

      const action = { type: actionType };

      if (actionType === 'turn_on' || actionType === 'turn_off') {
        action.value = document.getElementById('actionValue')?.value || '';
        if (!action.value) { alert('Kies eerst wat er aan/uit moet bij DAN!'); return null; }

        if (actionType === 'turn_on' && isLightEntity(action.value)) {
          const colorHex = document.getElementById('lightColor')?.value;
          if (colorHex) {
            action.color_rgb = colorHexToRgbArray(colorHex);
            action.colorPickerValue = colorHex;
          }
          const brightness = document.getElementById('lightBrightness')?.value;
          if (brightness !== undefined && brightness !== '') {
            action.brightness = parseInt(brightness);
          }
        }
      } else if (actionType === 'notify') {
        action.value = document.getElementById('actionValue')?.value || '';
        action.service = document.getElementById('notifyService')?.value || 'notify.notify';
        if (!action.value.trim()) { alert('Vul eerst een tekst in voor de melding!'); return null; }
      } else if (actionType === 'scene') {
        action.value = document.getElementById('actionValue')?.value || '';
        if (!action.value) { alert('Vul eerst een scene in!'); return null; }
      }

      return { name, trigger, action };
    }

    async function save() {
      const automation = readFormData();
      if (!automation) return;

      log(`Saving automation: ${automation.name}`, 'info');

      const isEdit = !!editingFilename;
      const url = isEdit
        ? `${API_BASE}/api/automation/${editingFilename}`
        : `${API_BASE}/api/automation`;
      const method = isEdit ? 'PUT' : 'POST';

      // 1) first attempt without confirmation
      try {
        let response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ automation, confirmed: false }),
        });

        let result = await response.json().catch(() => ({}));

        // confirmation required?
        if (response.status === 400 && result && result.require_confirmation) {
          const warningsText = formatWarnings(result.warnings);
          const ok = confirm(
            (result.message || 'Er zijn waarschuwingen gevonden.') +
            '\n\nWaarschuwingen:\n' + warningsText +
            '\n\nWil je toch doorgaan?'
          );

          if (!ok) {
            log('User cancelled after warnings', 'warn');
            alert('Geannuleerd. Niets opgeslagen.');
            return;
          }

          // 2) retry with confirmed: true
          response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ automation, confirmed: true }),
          });

          result = await response.json().catch(() => ({}));
        }

        if (response.ok) {
          log(`Success: ${result.message}`, 'success');

          if (result.warnings && result.warnings.length) {
            alert(result.message + '\n\nLet op (info):\n' + formatWarnings(result.warnings));
          } else {
            alert(result.message);
          }

          clearForm();
          editingFilename = null;
          hideEditBanner();
          loadList();
        } else {
          log(`Error: ${result.error || 'Onbekende fout'}`, 'error');
          alert(`Fout: ${result.error || 'Onbekende fout'}`);
        }
      } catch (error) {
        log(`Save failed: ${error.message}`, 'error');
        alert(`Fout bij opslaan: ${error.message}`);
      }
    }

    // ----------------------------
    // Test automation
    // ----------------------------
    async function testRun() {
      const automation = readFormData();
      if (!automation) return;

      log(`Testing automation: ${automation.name}`, 'info');

      const panel = document.getElementById('testPanel');
      const stepsContainer = document.getElementById('testSteps');
      panel.classList.remove('hidden');
      stepsContainer.innerHTML = renderActionPreviewCard(automation);

      try {
        const pendingCard = stepCard(
          { icon: '‚è≥', title: 'Bezig...', text: 'We sturen de test naar Home Assistant.', ok: true, extra: {} },
          'running'
        );
        stepsContainer.insertAdjacentHTML('beforeend', pendingCard);

        const response = await fetch(`${API_BASE}/api/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ automation }),
        });

        const result = await response.json().catch(() => ({}));

        stepsContainer.innerHTML = renderActionPreviewCard(automation);

        if (response.ok && result.steps) {
          result.steps.forEach(step => {
            const icon = step.ok ? '‚úÖ' : '‚ùå';
            const card = stepCard({
              icon,
              title: step.ok ? 'Gelukt' : 'Mislukt',
              text: step.message,
              ok: step.ok,
              extra: step.extra || {}
            });
            stepsContainer.insertAdjacentHTML('beforeend', card);
          });
          log('Test completed', result.success ? 'success' : 'warn');
        } else {
          const errorCard = stepCard({
            icon: '‚ùå',
            title: 'Fout',
            text: result.error || 'Onbekende fout',
            ok: false,
            extra: {}
          });
          stepsContainer.insertAdjacentHTML('beforeend', errorCard);
          log(`Test error: ${result.error}`, 'error');
        }
      } catch (error) {
        stepsContainer.innerHTML = renderActionPreviewCard(automation);
        const errorCard = stepCard({
          icon: '‚ùå',
          title: 'Verbindingsfout',
          text: error.message,
          ok: false,
          extra: {}
        });
        stepsContainer.insertAdjacentHTML('beforeend', errorCard);
        log(`Test failed: ${error.message}`, 'error');
      }
    }

    // ----------------------------
    // Search + List
    // ----------------------------
    function onSearchInput() {
      const q = (document.getElementById('searchBox')?.value || '').trim();
      currentQuery = q;

      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(() => loadList(), 200);
    }

    async function loadList() {
      try {
        let files = [];

        if (currentQuery && currentQuery.length > 0) {
          log(`Searching automations: "${currentQuery}"`, 'info');
          const { resp, data } = await postJSON(`${API_BASE}/api/automations/search`, { query: currentQuery });
          if (resp.ok) files = data;
          else files = [];
        } else {
          const response = await fetch(`${API_BASE}/api/automations`);
          files = await response.json().catch(() => []);
        }

        const listEl = document.getElementById('list');
        const countEl = document.getElementById('count');
        const itemsEl = document.getElementById('items');

        countEl.textContent = (files || []).length;

        if (!files || files.length === 0) {
          listEl.classList.add('hidden');
          log('No automations found', 'info');
          return;
        }

        listEl.classList.remove('hidden');
        itemsEl.innerHTML = '';

        files.forEach(file => {
          const filename = file.filename || '';
          const card = document.createElement('div');
          card.className = 'border-2 border-gray-200 rounded-xl p-4 hover:border-blue-300 transition-colors';
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="font-semibold text-gray-800">${escapeHtml(file.name || 'Onbekend')}</div>
                <div class="text-xs text-gray-500 font-mono mt-1">${escapeHtml(filename)}</div>
              </div>
              <div class="flex gap-2">
                <button onclick="editAutomation('${escapeHtml(filename)}')"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                  ‚úèÔ∏è Bewerken
                </button>
                <button onclick="deleteAutomation('${escapeHtml(filename)}')"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                  üóëÔ∏è Verwijderen
                </button>
              </div>
            </div>
          `;
          itemsEl.appendChild(card);
        });

        log(`Loaded ${files.length} automations`, 'success');
      } catch (error) {
        log(`Failed to load list: ${error.message}`, 'error');
      }
    }

    async function editAutomation(filename) {
      try {
        log(`Loading automation for edit: ${filename}`, 'info');
        const response = await fetch(`${API_BASE}/api/automation/${filename}`);
        const result = await response.json().catch(() => ({}));

        if (!response.ok) {
          alert(`Fout: ${result.error || 'Onbekende fout'}`);
          return;
        }

        const automation = result.automation;
        editingFilename = result.filename;

        document.getElementById('name').value = automation.name;
        document.getElementById('triggerType').value = automation.trigger.type;
        showTrigger(automation.trigger);

        document.getElementById('actionType').value = automation.action.type;
        showAction(automation.action);

        showEditBanner(result.filename);
        window.scrollTo({ top: 0, behavior: 'smooth' });

        log(`Edit mode: ${filename}`, 'info');
      } catch (error) {
        log(`Edit failed: ${error.message}`, 'error');
        alert(`Fout bij laden: ${error.message}`);
      }
    }

    async function deleteAutomation(filename) {
      if (!confirm(`Weet je zeker dat je "${filename}" wilt verwijderen?`)) return;

      try {
        log(`Deleting automation: ${filename}`, 'warn');
        const response = await fetch(`${API_BASE}/api/automation/${filename}`, {
          method: 'DELETE',
        });

        const result = await response.json().catch(() => ({}));

        if (response.ok) {
          log(`Deleted: ${filename}`, 'success');
          alert(result.message);
          loadList();
        } else {
          log(`Delete error: ${result.error}`, 'error');
          alert(`Fout: ${result.error}`);
        }
      } catch (error) {
        log(`Delete failed: ${error.message}`, 'error');
        alert(`Fout bij verwijderen: ${error.message}`);
      }
    }

    // ----------------------------
    // Init on page load
    // ----------------------------
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
